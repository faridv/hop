"use strict";var __extends=this&&this.__extends||function(){var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var quran_service_1=require("./quran.service"),libs_1=require("../../libs"),QuranModule=function(i){function t(t,e){var n=i.call(this,t,e)||this;return n.template={quran:"./quran.template.html",surah:"./surah.template.html"},n.events={"quran.top":{control:"up",title:"بالا",icon:"up",button:!1},"quran.bottom":{control:"down",title:"پایین",icon:"bottom",button:!1},"quran.left":{control:"left",title:"چپ",icon:"left",button:!1},"quran.right":{control:"right",title:"راست",icon:"right",button:!1},"quran.enter":{control:"enter",title:"نمایش متن",icon:"enter"},"quran.toggle":{control:"blue,b",title:"نمایش ترجمه"},"quran.up":{control:"up",title:"اسکرول بالا",icon:"up",button:!1},"quran.down":{control:"down",title:"اسکرول پایین",icon:"bottom",button:!1},"quran.back":{control:"back,backspace",title:"بازگشت به سوره‌ها",icon:"refresh"}},n.service=quran_service_1.QuranService.instance,n.events=n.prepareControls(),n.load(),n}return __extends(t,i),t.prototype.load=function(){var e=this;this.templateHelper.loading(),this.service.getSurahList().done(function(t){e.data=t.data,e.render(e.data,function(){e.templateHelper.loading(!1),e.initializeSurahListSlider()})})},t.prototype.render=function(t,e){var n=require(""+this.template.quran);this.templateHelper.render(n,t,this.$el,"html",function(){"function"==typeof e&&e()})},t.prototype.initializeSurahListSlider=function(){var t=$("#surah-list");this.registerKeyboardInputs(t)},t.prototype.navigateSurahList=function(t,e){void 0===e&&(e=$("#surah-list"));var n=$("li.active"),i=e.find("li").eq(n.index()+t);if(n.removeClass("active"),i.length){i.addClass("active");var r=i.offset().top-e.offset().top+e.scrollTop();~~e.scrollTop()!=~~r&&e.stop().animate({scrollTop:~~r})}else{e.find("li").eq(0).addClass("active"),e.stop().animate({scrollTop:0})}},t.prototype.registerKeyboardInputs=function(t){void 0===t&&(t=$("#surah-list"));var e=this;this.input.addEvent("up",!1,this.events["quran.top"],function(){e.navigateSurahList(-4)}),this.input.addEvent("down",!1,this.events["quran.bottom"],function(){e.navigateSurahList(4)}),this.input.addEvent("left",!1,this.events["quran.left"],function(){e.navigateSurahList(1)}),this.input.addEvent("right",!1,this.events["quran.right"],function(){e.navigateSurahList(-1)}),e.input.addEvent("enter",!1,this.events["quran.enter"],function(){e.loadSurah(~~t.find("li.active").data("id"))})},t.prototype.loadSurah=function(t){var e=this;this.templateHelper.loading(),this.service.getSurah(t).done(function(t){e.currentSurah=t.data,e.renderSurah(e.currentSurah,function(t){e.templateHelper.loading(!1),e.registerSurahKeyboardInputs(),e.initLineHighlighter()})})},t.prototype.renderSurah=function(t,e){var n=require(""+this.template.surah);this.templateHelper.render(n,t,$("#surah"),"html",function(){"function"==typeof e&&e(t)})},t.prototype.registerSurahKeyboardInputs=function(){var n=this;this.destroyEvents(this)&&(this.input.removeEvent("back,backspace",{key:"module.exit"}),this.input.addEvent("back,backspace",!1,this.events["quran.back"],function(){n.unloadSurah()}),this.input.addEvent("blue,b",!1,this.events["quran.toggle"],function(){$(".edition").toggleClass("active")}),this.input.addEvent("up",!1,this.events["quran.up"],function(){var t=$(".edition.active"),e=t.scrollTop()-n.getAyahLineHeight();console.log(t.scrollTop(),n.getAyahLineHeight(),e),t.animate({scrollTop:e<=0?0:e},300)}),this.input.addEvent("down",!1,this.events["quran.down"],function(){var t=$(".edition.active"),e=t.scrollTop()+n.getAyahLineHeight();console.log(t.scrollTop(),n.getAyahLineHeight(),e),t.animate({scrollTop:e},300)}))},t.prototype.initLineHighlighter=function(){var t=$(".active-line:first"),e=$(".surah-body");30<$(".surah-header").offset().top&&t.css({top:e.offset().top})},t.prototype.getAyahLineHeight=function(){return parseInt($(".edition.active").find(".surah-body").css("line-height"))},t.prototype.unloadSurah=function(){var t=this;$("#surah").empty(),this.input.removeEvent("back,backspace",{key:"quran.back"}),this.input.removeEvent("up",{key:"quran.up"}),this.input.removeEvent("down",{key:"quran.down"}),this.input.removeEvent("blue,b",{key:"quran.toggle"}),this.registerKeyboardInputs(),setTimeout(function(){t.layoutInstance.prepareUnloadModule()},500)},t}(libs_1.Module);exports.default=QuranModule;